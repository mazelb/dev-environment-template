services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-api}-service
    ports:
      - '${API_PORT:-8000}:8000'
    environment:
      - API_SECRET_KEY=${API_SECRET_KEY}
      - API_ALGORITHM=${API_ALGORITHM:-HS256}
      - API_ACCESS_TOKEN_EXPIRE_MINUTES=${API_ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-60}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
    volumes:
      - ./src:/app/src
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - api-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    container_name: ${PROJECT_NAME:-api}-redis
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - api-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:16-alpine
    container_name: ${PROJECT_NAME:-api}-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-api_db}
      - POSTGRES_USER=${POSTGRES_USER:-api_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-api_password}
      - POSTGRES_HOST_AUTH_METHOD=password
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-api_user} -d ${POSTGRES_DB:-api_db}']
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - api-network

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-api}-celery-worker
    command: celery -A src.celery_app.celery worker --loglevel=info
    environment:
      - API_SECRET_KEY=${API_SECRET_KEY}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - POSTGRES_DB=${POSTGRES_DB:-api_db}
      - POSTGRES_USER=${POSTGRES_USER:-api_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-api_password}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
    volumes:
      - ./src:/app/src
      - ./logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - api-network

  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-api}-flower
    command: celery -A src.celery_app.celery flower --port=5555
    ports:
      - '${FLOWER_PORT:-5555}:5555'
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      - redis
      - celery-worker
    restart: unless-stopped
    networks:
      - api-network

volumes:
  redis-data:
    driver: local
  postgres-data:
    driver: local

networks:
  api-network:
    driver: bridge
